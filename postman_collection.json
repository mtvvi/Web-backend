{
	"info": {
		"name": "License Management API - Lab 4",
		"description": "Коллекция запросов для тестирования веб-сервиса лицензирования ПО с JWT авторизацией",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{jwt_token}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "jwt_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "base_url",
			"value": "http://127.0.0.1:8080",
			"type": "string"
		}
	],
	"item": [
		{
			"name": "Аутентификация",
			"item": [
				{
					"name": "Регистрация buyer1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"login\": \"buyer1\",\n  \"password\": \"password123\",\n  \"full_name\": \"Покупатель Иван\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/register",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "register"]
						}
					},
					"response": []
				},
				{
					"name": "Регистрация admin1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"login\": \"admin1\",\n  \"password\": \"admin123\",\n  \"full_name\": \"Администратор Петр\",\n  \"role\": 2\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/register",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "register"]
						}
					},
					"response": []
				},
				{
					"name": "Логин buyer1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.data) {",
									"    pm.collectionVariables.set(\"jwt_token\", jsonData.data);",
									"    console.log(\"JWT Token saved: \" + jsonData.data);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"login\": \"buyer1\",\n  \"password\": \"password123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/login",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "login"]
						}
					},
					"response": []
				},
				{
					"name": "Логин admin1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.data) {",
									"    pm.collectionVariables.set(\"jwt_token\", jsonData.data);",
									"    console.log(\"JWT Token saved: \" + jsonData.data);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"login\": \"admin1\",\n  \"password\": \"admin123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/login",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "login"]
						}
					},
					"response": []
				},
				{
					"name": "Профиль пользователя",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/auth/profile",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "profile"]
						}
					},
					"response": []
				},
				{
					"name": "Обновить профиль",
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"full_name\": \"Покупатель Иван Иванович\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/profile",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "profile"]
						}
					},
					"response": []
				},
				{
					"name": "Выход",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/auth/logout",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "logout"]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Лицензии",
			"item": [
				{
					"name": "Список услуг",
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services",
							"host": ["{{base_url}}"],
							"path": ["api", "services"]
						}
					},
					"response": []
				},
				{
					"name": "Список услуг с фильтром",
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services?query=Windows&license_type=perpetual",
							"host": ["{{base_url}}"],
							"path": ["api", "services"],
							"query": [
								{"key": "query", "value": "Windows"},
								{"key": "license_type", "value": "perpetual"}
							]
						}
					},
					"response": []
				},
				{
					"name": "Одна услуга",
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services/1",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "1"]
						}
					},
					"response": []
				},
				{
					"name": "Создание услуги",
					"request": {
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"Adobe Photoshop CC\",\n  \"description\": \"Профессиональный редактор изображений\",\n  \"base_price\": 2500.00,\n  \"license_type\": \"subscription\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/services",
							"host": ["{{base_url}}"],
							"path": ["api", "services"]
						}
					},
					"response": []
				},
				{
					"name": "Изменение услуги",
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"Adobe Photoshop CC Pro\",\n  \"base_price\": 3000.00,\n  \"description\": \"Обновленная версия с новыми возможностями\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/services/6",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "6"]
						}
					},
					"response": []
				},
				{
					"name": "Удаление услуги",
					"request": {
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services/6",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "6"]
						}
					},
					"response": []
				},
				{
					"name": "Добавить услугу в заявку",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services/1/add-to-licenseCalculationRequest",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "1", "add-to-licenseCalculationRequest"]
						}
					},
					"response": []
				},
				{
					"name": "Добавить изображение",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "image",
									"type": "file",
									"src": "resources/img/service_icon.png",
									"description": "Файл изображения для услуги"
								}
							]
						},
						"url": {
							"raw": "{{base_url}}/api/services/1/image",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "1", "image"]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Заявки",
			"item": [
				{
					"name": "Иконка корзины",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/cart",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "cart"]
						},
						"description": "Возвращает ID черновика текущего пользователя и количество услуг в нем"
					},
					"response": []
				},
				{
					"name": "Список заявок",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests"]
						},
						"description": "Возвращает заявки кроме удаленных и черновиков. Buyer видит только свои, Admin видит все"
					},
					"response": []
				},
				{
					"name": "Список заявок с фильтром по статусу",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests?status=сформирован",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests"],
							"query": [
								{"key": "status", "value": "сформирован"}
							]
						}
					},
					"response": []
				},
				{
					"name": "Список заявок с фильтром по дате",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests?date_from=2024-01-01&date_to=2025-12-31",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests"],
							"query": [
								{"key": "date_from", "value": "2024-01-01"},
								{"key": "date_to", "value": "2025-12-31"}
							]
						}
					},
					"response": []
				},
				{
					"name": "Список заявок с комбинированным фильтром",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests?status=завершен&date_from=2024-10-01&date_to=2025-10-31",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests"],
							"query": [
								{"key": "status", "value": "завершен"},
								{"key": "date_from", "value": "2024-10-01"},
								{"key": "date_to", "value": "2025-10-31"}
							]
						}
					},
					"response": []
				},
				{
					"name": "Одна заявка",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/1",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "1"]
						},
						"description": "Возвращает поля заявки + список услуг с изображениями"
					},
					"response": []
				},
				{
					"name": "Изменить поля заявки",
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"users\": 20,\n  \"cores\": 16,\n  \"period\": 3\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/1",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "1"]
						},
						"description": "Изменение полей: users, cores, period"
					},
					"response": []
				},
				{
					"name": "Сформировать заявку",
					"request": {
						"method": "PUT",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/1/format",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "1", "format"]
						},
						"description": "Проверяет обязательные поля и меняет статус на 'сформирован'. Проставляется дата формирования"
					},
					"response": []
				},
				{
					"name": "Завершить заявку",
					"request": {
						"method": "PUT",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/2/complete",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "2", "complete"]
						},
						"description": "Проставляется модератор, дата завершения. Рассчитывается стоимость и дата доставки"
					},
					"response": []
				},
				{
					"name": "Отклонить заявку",
					"request": {
						"method": "PUT",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/3/reject",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "3", "reject"]
						},
						"description": "Проставляется модератор, дата завершения, статус 'отклонен'"
					},
					"response": []
				},
				{
					"name": "Удалить заявку",
					"request": {
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/1",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "1"]
						},
						"description": "Удаление заявки (мягкое удаление или проверка статуса)"
					},
					"response": []
				}
			]
		},
		{
			"name": "Лицензии в заявке",
			"item": [
				{
					"name": "Изменить коэффициент поддержки",
					"request": {
						"method": "PUT",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"support_level\": 1.5\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequest-services/1/1",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequest-services", "1", "1"]
						},
						"description": "Изменение значений в связи М-М (без PK, через licenseCalculationRequest_id/service_id)"
					},
					"response": []
				},
				{
					"name": "Удалить услугу из заявки",
					"request": {
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequest-services/1/2",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequest-services", "1", "2"]
						},
						"description": "Удаление услуги из заявки (без PK М-М, через licenseCalculationRequest_id/service_id)"
					},
					"response": []
				}
			]
		},
		{
			"name": "Тестовые запросы с ошибками",
			"item": [
				{
					"name": "Попытка без авторизации (401)",
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services/1/add-to-licenseCalculationRequest",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "1", "add-to-licenseCalculationRequest"]
						},
						"description": "Попытка защищенного действия без авторизации"
					},
					"response": []
				},
				{
					"name": "Buyer создает услугу (403)",
					"request": {
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"Test Service\",\n  \"description\": \"Test\",\n  \"base_price\": 1000,\n  \"license_type\": \"perpetual\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/services",
							"host": ["{{base_url}}"],
							"path": ["api", "services"]
						},
						"description": "Buyer пытается создать услугу (только Admin)"
					},
					"response": []
				},
				{
					"name": "Buyer завершает заявку (403)",
					"request": {
						"method": "PUT",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/licenseCalculationRequests/1/complete",
							"host": ["{{base_url}}"],
							"path": ["api", "licenseCalculationRequests", "1", "complete"]
						},
						"description": "Buyer пытается завершить заявку (только Admin)"
					},
					"response": []
				},
				{
					"name": "Несуществующая услуга (404)",
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/services/999999",
							"host": ["{{base_url}}"],
							"path": ["api", "services", "999999"]
						}
					},
					"response": []
				},
				{
					"name": "Неверные данные (400)",
					"request": {
						"method": "POST",
						"header": [{"key": "Content-Type", "value": "application/json"}],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"\",\n  \"base_price\": -100\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/services",
							"host": ["{{base_url}}"],
							"path": ["api", "services"]
						}
					},
					"response": []
				},
				{
					"name": "Токен в blacklist после logout (401)",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/auth/logout",
							"host": ["{{base_url}}"],
							"path": ["api", "auth", "logout"]
						},
						"description": "Проверка, что токен в blacklist после первого logout"
					},
					"response": []
				}
			]
		}
	]
}
